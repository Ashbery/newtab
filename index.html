<script>
    // 時鐘功能
    function updateClock() {
        const now = new Date();
        const time = now.toLocaleTimeString('zh-TW');
        const date = now.toLocaleDateString('zh-TW', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'long'
        });
        
        document.getElementById('clock').textContent = time;
        document.getElementById('date').textContent = date;
    }

    updateClock();
    setInterval(updateClock, 1000);

    // 搜尋功能
    const searchInput = document.getElementById('search-input');

    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const query = this.value.trim();
            if (query) {
                if (query.includes('.') || query.includes('://')) {
                    window.location.href = query.includes('://') ? query : 'https://' + query;
                } else {
                    window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                }
            }
        }
    });

    // 影片控制
    const video = document.getElementById('video-background');
    const uploadContainer = document.getElementById('video-upload-container');
    const settingsMenu = document.getElementById('settings-menu');
    const settingsGear = document.getElementById('settings-gear');
    let selectedFile = null;
    let selectedVideoUrl = '';

    // ==================== 擴充功能通訊代碼開始 ====================
    
    // 檢查是否在擴充功能環境中
    function isExtensionEnvironment() {
        return typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id;
    }

    // 儲存影片到擴充功能
    async function saveVideoToExtension(file) {
        return new Promise((resolve, reject) => {
            if (!isExtensionEnvironment()) {
                reject(new Error('不在擴充功能環境中'));
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                // 將檔案轉為 Base64 並儲存
                chrome.runtime.sendMessage(chrome.runtime.id, {
                    action: 'saveVideo',
                    data: e.target.result,
                    type: 'base64',
                    name: file.name,
                    size: file.size
                }, (response) => {
                    if (response && response.success) {
                        resolve();
                    } else {
                        reject(new Error('儲存失敗'));
                    }
                });
            };
            reader.onerror = () => reject(reader.error);
            reader.readAsDataURL(file);
        });
    }

    // 從擴充功能載入影片
    async function loadVideoFromExtension() {
        return new Promise((resolve) => {
            if (!isExtensionEnvironment()) {
                resolve(null);
                return;
            }

            chrome.runtime.sendMessage(chrome.runtime.id, {
                action: 'loadVideo'
            }, (response) => {
                resolve(response);
            });
        });
    }

    // 清除擴充功能中的影片
    async function clearVideoFromExtension() {
        return new Promise((resolve) => {
            if (!isExtensionEnvironment()) {
                resolve();
                return;
            }

            chrome.runtime.sendMessage(chrome.runtime.id, {
                action: 'clearVideo'
            }, (response) => {
                resolve(response);
            });
        });
    }

    // 優先從擴充功能載入，失敗則使用 localStorage
    async function loadVideoWithFallback() {
        let savedData = null;
        
        // 1. 優先從擴充功能載入
        if (isExtensionEnvironment()) {
            try {
                savedData = await loadVideoFromExtension();
                console.log('從擴充功能載入影片資料:', savedData ? '成功' : '無資料');
            } catch (error) {
                console.error('從擴充功能載入失敗:', error);
            }
        }
        
        // 2. 如果擴充功能沒有資料，嘗試從 localStorage 載入
        if (!savedData || !savedData.customVideo) {
            const localVideo = localStorage.getItem('customVideo');
            const localSource = localStorage.getItem('videoSource');
            const localName = localStorage.getItem('videoName');
            
            if (localVideo) {
                savedData = {
                    customVideo: localVideo,
                    videoType: localSource,
                    videoName: localName
                };
                console.log('從 localStorage 載入影片資料');
            }
        }
        
        return savedData;
    }

    // ==================== 擴充功能通訊代碼結束 ====================

    // 齒輪點擊事件
    settingsGear.addEventListener('click', function() {
        settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
    });

    // 點擊頁面其他區域關閉選單
    document.addEventListener('click', function(event) {
        if (!settingsGear.contains(event.target) && !settingsMenu.contains(event.target)) {
            settingsMenu.style.display = 'none';
        }
    });

    // 播放/暫停
    document.getElementById('play-pause-btn').addEventListener('click', function() {
        if (video.paused) {
            video.play();
            this.innerHTML = '<i class="fas fa-pause"></i><span>暫停影片</span>';
        } else {
            video.pause();
            this.innerHTML = '<i class="fas fa-play"></i><span>播放影片</span>';
        }
        settingsMenu.style.display = 'none';
    });

    // 靜音/取消靜音
    document.getElementById('mute-btn').addEventListener('click', function() {
        video.muted = !video.muted;
        this.innerHTML = video.muted ? 
            '<i class="fas fa-volume-mute"></i><span>取消靜音</span>' : 
            '<i class="fas fa-volume-up"></i><span>靜音影片</span>';
        settingsMenu.style.display = 'none';
    });

    // 上傳影片介面
    document.getElementById('upload-video-btn').addEventListener('click', function() {
        uploadContainer.style.display = 'flex';
        settingsMenu.style.display = 'none';
    });

    document.getElementById('close-upload').addEventListener('click', function() {
        uploadContainer.style.display = 'none';
    });

    // 檔案選擇
    document.getElementById('video-file').addEventListener('change', function(e) {
        selectedFile = e.target.files[0];
        selectedVideoUrl = '';
        document.getElementById('video-url').value = '';
        
        if (selectedFile && selectedFile.type === 'video/mp4') {
            document.getElementById('confirm-upload').disabled = false;
        } else {
            document.getElementById('confirm-upload').disabled = true;
            alert('請選擇 MP4 格式的影片檔案');
        }
    });

    // 網址載入
    document.getElementById('load-url-btn').addEventListener('click', function() {
        const url = document.getElementById('video-url').value.trim();
        if (url) {
            selectedVideoUrl = url;
            selectedFile = null;
            document.getElementById('video-file').value = '';
            document.getElementById('confirm-upload').disabled = false;
        } else {
            alert('請輸入影片網址');
        }
    });

    // 確認設定 - 修改為支援擴充功能
    document.getElementById('confirm-upload').addEventListener('click', async function() {
        if (selectedFile) {
            // 上傳本地檔案
            const loadingIndicator = document.createElement('div');
            loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在儲存影片...';
            loadingIndicator.style.color = '#4a6cf7';
            loadingIndicator.style.marginTop = '10px';
            this.parentNode.appendChild(loadingIndicator);
            
            this.disabled = true;
            
            try {
                // 立即播放
                const videoURL = URL.createObjectURL(selectedFile);
                video.src = videoURL;
                await video.play();
                
                // 優先儲存到擴充功能
                if (isExtensionEnvironment()) {
                    await saveVideoToExtension(selectedFile);
                    console.log('影片已儲存到擴充功能');
                }
                
                // 備用：儲存到 localStorage
                localStorage.setItem('customVideo', videoURL);
                localStorage.setItem('videoSource', 'file');
                localStorage.setItem('videoName', selectedFile.name);
                
                updateCurrentVideoInfo(selectedFile.name);
                
            } catch (error) {
                console.error('處理影片失敗:', error);
                alert('處理影片失敗: ' + error.message);
            } finally {
                loadingIndicator.remove();
                this.disabled = false;
                uploadContainer.style.display = 'none';
                resetUploadForm();
            }
            
        } else if (selectedVideoUrl) {
            // 使用網址影片
            video.src = selectedVideoUrl;
            video.play();
            
            // 儲存網址設定
            if (isExtensionEnvironment()) {
                chrome.runtime.sendMessage(chrome.runtime.id, {
                    action: 'saveVideoUrl',
                    url: selectedVideoUrl,
                    name: '自訂網址影片'
                });
            }
            
            localStorage.setItem('customVideo', selectedVideoUrl);
            localStorage.setItem('videoSource', 'url');
            localStorage.setItem('videoName', '自訂網址影片');
            
            updateCurrentVideoInfo('自訂網址影片');
            
            uploadContainer.style.display = 'none';
            resetUploadForm();
        }
    });

    function resetUploadForm() {
        document.getElementById('video-file').value = '';
        document.getElementById('video-url').value = '';
        document.getElementById('confirm-upload').disabled = true;
        selectedFile = null;
        selectedVideoUrl = '';
    }

    function updateCurrentVideoInfo(name) {
        document.getElementById('current-video-info').style.display = 'block';
        document.getElementById('current-video-name').textContent = name;
    }

    // 載入儲存的影片 - 修改為支援擴充功能
    window.addEventListener('DOMContentLoaded', async function() {
        const savedData = await loadVideoWithFallback();
        
        if (savedData && savedData.customVideo) {
            video.src = savedData.customVideo;
            updateCurrentVideoInfo(savedData.videoName || '自訂影片');
            console.log('載入自訂背景影片');
        } else {
            console.log('使用預設背景影片');
        }
        
        video.play().catch(e => {
            console.log('自動播放被阻止，需要用戶互動');
        });
        
        // 聚焦搜尋框
        searchInput.focus();

        // 顯示當前環境
        if (isExtensionEnvironment()) {
            console.log('運行在擴充功能環境中');
        } else {
            console.log('運行在普通網頁環境中');
        }
    });

    // 處理影片載入錯誤
    video.addEventListener('error', function() {
        console.error('影片載入失敗');
        // 如果自訂影片失敗，恢復預設影片
        const defaultVideo = 'https://assets.mixkit.co/videos/preview/mixkit-white-clouds-passing-by-1152-large.mp4';
        video.src = defaultVideo;
        video.play();
        updateCurrentVideoInfo('預設影片（自訂影片載入失敗）');
    });
</script>
