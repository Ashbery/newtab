<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ashbery æ–°åˆ†é </title>
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.ico">
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <video id="video-background" autoplay muted loop>
        <source src="https://assets.mixkit.co/videos/preview/mixkit-white-clouds-passing-by-1152-large.mp4" type="video/mp4">
    </video>
    <div class="overlay"></div>

    <div class="header-container">
        <div class="time-container">
            <div class="clock" id="clock">00:00:00</div>
            <div class="date" id="date">2023å¹´1æœˆ1æ—¥ æ˜ŸæœŸä¸€</div>
        </div>

        <div class="search-container">
            <div class="search-box">
                <input type="text" class="search-input" id="search-input" placeholder="æœå°‹ Google æˆ–è¼¸å…¥ç¶²å€">
            </div>
        </div>
    </div>

    <!-- å³ä¸Šè§’å¿«æ·éµ -->
    <div class="quick-links">
        <a href="https://www.google.com/imghp" class="quick-link" target="_blank">åœ–ç‰‡</a>
        <a href="https://mail.google.com" class="quick-link" target="_blank">Gmail</a>
        
        <!-- Google æ‡‰ç”¨ç¨‹å¼è³‡æ–™å¤¾ -->
        <div class="google-apps-container">
            <button class="google-apps-btn" id="google-apps-btn">
                <i class="fas fa-th"></i>
            </button>
            <div class="google-apps-menu" id="google-apps-menu">
                <div class="apps-grid">
                    <a href="https://drive.google.com" class="app-item" target="_blank" title="Google é›²ç«¯ç¡¬ç¢Ÿ">
                        <div class="app-icon">
                            <i class="fab fa-google-drive"></i>
                        </div>
                        <span class="app-name">é›²ç«¯ç¡¬ç¢Ÿ</span>
                    </a>
                    <a href="https://maps.google.com" class="app-item" target="_blank" title="Google åœ°åœ–">
                        <div class="app-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <span class="app-name">åœ°åœ–</span>
                    </a>
                    <a href="https://photos.google.com" class="app-item" target="_blank" title="Google ç›¸ç°¿">
                        <div class="app-icon">
                            <i class="fas fa-images"></i>
                        </div>
                        <span class="app-name">ç›¸ç°¿</span>
                    </a>
                    <a href="https://calendar.google.com" class="app-item" target="_blank" title="Google æ—¥æ›†">
                        <div class="app-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <span class="app-name">æ—¥æ›†</span>
                    </a>
                    <a href="https://keep.google.com" class="app-item" target="_blank" title="Google Keep">
                        <div class="app-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <span class="app-name">Keep</span>
                    </a>
                    <a href="https://contacts.google.com" class="app-item" target="_blank" title="Google è¯çµ¡äºº">
                        <div class="app-icon">
                            <i class="fas fa-address-book"></i>
                        </div>
                        <span class="app-name">è¯çµ¡äºº</span>
                    </a>
                    <a href="https://translate.google.com" class="app-item" target="_blank" title="Google ç¿»è­¯">
                        <div class="app-icon">
                            <i class="fas fa-language"></i>
                        </div>
                        <span class="app-name">ç¿»è­¯</span>
                    </a>
                    <a href="https://news.google.com" class="app-item" target="_blank" title="Google æ–°è">
                        <div class="app-icon">
                            <i class="fas fa-newspaper"></i>
                        </div>
                        <span class="app-name">æ–°è</span>
                    </a>
                    <a href="https://meet.google.com" class="app-item" target="_blank" title="Google Meet">
                        <div class="app-icon">
                            <i class="fas fa-video"></i>
                        </div>
                        <span class="app-name">Meet</span>
                    </a>
                    <a href="https://chat.google.com" class="app-item" target="_blank" title="Google Chat">
                        <div class="app-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <span class="app-name">Chat</span>
                    </a>
                    <a href="https://docs.google.com" class="app-item" target="_blank" title="Google æ–‡ä»¶">
                        <div class="app-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <span class="app-name">æ–‡ä»¶</span>
                    </a>
                    <a href="https://sheets.google.com" class="app-item" target="_blank" title="Google è©¦ç®—è¡¨">
                        <div class="app-icon">
                            <i class="fas fa-table"></i>
                        </div>
                        <span class="app-name">è©¦ç®—è¡¨</span>
                    </a>
                </div>
                <div class="apps-footer">
                    <a href="https://www.google.com/intl/zh-TW/about/products" class="more-apps" target="_blank">
                        <i class="fas fa-th-large"></i>
                        <span>æ›´å¤š Google æ‡‰ç”¨ç¨‹å¼</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Google ç™»å…¥æŒ‰éˆ• - ä½¿ç”¨ç¶²ç«™ favicon -->
        <div class="google-login-container">
            <button class="google-login-btn" id="google-login-btn">
                <img src="favicon.ico" class="google-icon" alt="Google">
                <span>Google</span>
            </button>
            <div class="google-login-menu" id="google-login-menu">
                <div class="login-menu-item" id="setup-google-api-btn">
                    <i class="fas fa-cog"></i>
                    <span>è¨­å®š API</span>
                </div>
                <div class="login-menu-item" id="google-drive-picker-btn" style="display: none;">
                    <i class="fab fa-google-drive"></i>
                    <span>é¸æ“‡å½±ç‰‡</span>
                </div>
                <div class="login-menu-item" id="google-logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ç™»å‡º</span>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¸‹è§’é½’è¼ªåœ–æ¨™ -->
    <div class="settings-gear" id="settings-gear">
        <i class="fas fa-cog"></i>
    </div>

    <!-- è¨­å®šé¸å–® -->
    <div class="settings-menu" id="settings-menu">
        <div class="menu-item" id="play-pause-btn">
            <i class="fas fa-play"></i>
            <span>æ’­æ”¾/æš«åœ</span>
        </div>
        <div class="menu-item" id="mute-btn">
            <i class="fas fa-volume-up"></i>
            <span>éœéŸ³/å–æ¶ˆéœéŸ³</span>
        </div>
        <div class="menu-item" id="upload-video-btn">
            <i class="fas fa-upload"></i>
            <span>ä¸Šå‚³èƒŒæ™¯å½±ç‰‡</span>
        </div>
    </div>

    <!-- å½±ç‰‡ä¸Šå‚³å®¹å™¨ -->
    <div class="video-upload-container" id="video-upload-container">
        <div class="upload-box">
            <button class="close-upload" id="close-upload">
                <i class="fas fa-times"></i>
            </button>
            <h3>ä¸Šå‚³è‡ªè¨‚èƒŒæ™¯å½±ç‰‡</h3>
            
            <!-- é›²ç«¯ä¸Šå‚³é¸é … -->
            <div class="upload-options">
                <button class="cloud-upload-btn google" id="google-drive-btn" disabled>
                    <i class="fab fa-google-drive"></i>
                    Google Drive
                </button>
            </div>

            <div id="google-drive-status" class="google-status">
                è«‹å…ˆè¨­å®š Google API ä¸¦ç™»å…¥
            </div>

            <div class="upload-status" id="upload-status"></div>

            <div class="divider">
                <span>æˆ–ä½¿ç”¨æœ¬åœ°æª”æ¡ˆ</span>
            </div>

            <!-- æœ¬åœ°æª”æ¡ˆä¸Šå‚³ -->
            <div class="file-input-wrapper">
                <input type="file" id="video-file" accept="video/mp4" class="file-input">
                <div class="file-info" id="file-info">
                    æ”¯æ´ MP4 æ ¼å¼ï¼Œæœ€å¤§ 50MB
                </div>
            </div>

            <div class="progress-bar" id="progress-bar">
                <div class="progress" id="progress"></div>
            </div>

            <div style="margin: 20px 0; text-align: center; color: #666;">
                â€” æˆ–è¼¸å…¥ç¶²å€ â€”
            </div>

            <!-- ç¶²å€è¼¸å…¥ -->
            <div>
                <input type="url" id="video-url" class="url-input" placeholder="è¼¸å…¥å½±ç‰‡ç¶²å€ (MP4)">
                <button id="load-url-btn" class="upload-btn">è¼‰å…¥ç¶²å€å½±ç‰‡</button>
            </div>

            <button id="confirm-upload" class="upload-btn" disabled>ç¢ºèªè¨­å®š</button>

            <div class="current-video" id="current-video-info" style="display: none;">
                ç›®å‰ä½¿ç”¨: <span id="current-video-name">é è¨­å½±ç‰‡</span>
            </div>

            <div class="storage-info">
                ğŸ’¡ ä½¿ç”¨ Google Drive å¯ç²å¾—æœ€ä½³è¼‰å…¥é€Ÿåº¦
            </div>
        </div>
    </div>

    <!-- Google API è¨­å®šå®¹å™¨ -->
    <div class="api-setup-container" id="api-setup-container">
        <div class="setup-box">
            <button class="close-upload" id="close-api-setup">
                <i class="fas fa-times"></i>
            </button>
            <h3>è¨­å®š Google API</h3>
            
            <div class="setup-instructions">
                <h4>å¦‚ä½•å–å¾— Google OAuth ç”¨æˆ¶ç«¯ IDï¼š</h4>
                <ol>
                    <li>è¨ªå• <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                    <li>å»ºç«‹æ–°å°ˆæ¡ˆæˆ–é¸æ“‡ç¾æœ‰å°ˆæ¡ˆ</li>
                    <li>å•Ÿç”¨ <strong>Google Drive API</strong> å’Œ <strong>Google Picker API</strong></li>
                    <li>å‰å¾€ã€ŒAPI å’Œæœå‹™ã€â†’ã€ŒOAuth åŒæ„ç•«é¢ã€è¨­å®šæ‡‰ç”¨ç¨‹å¼åç¨±</li>
                    <li>å‰å¾€ã€Œæ†‘è­‰ã€â†’ã€Œå»ºç«‹æ†‘è­‰ã€â†’ã€ŒOAuth ç”¨æˆ¶ç«¯ IDã€</li>
                    <li>æ‡‰ç”¨ç¨‹å¼é¡å‹é¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</li>
                    <li>åœ¨ã€Œå·²æˆæ¬Šçš„ JavaScript ä¾†æºã€ä¸­æ·»åŠ ï¼š<code>https://ashbery.github.io</code></li>
                    <li>è¤‡è£½ã€Œç”¨æˆ¶ç«¯ IDã€ä¸¦è²¼åˆ°ä¸‹æ–¹æ¬„ä½</li>
                </ol>
            </div>

            <div class="form-group">
                <label for="google-client-id">Google OAuth ç”¨æˆ¶ç«¯ IDï¼š</label>
                <input type="text" id="google-client-id" class="url-input" 
                       placeholder="xxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com">
                <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                    æ ¼å¼æ‡‰ç‚ºï¼šxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx.apps.googleusercontent.com
                </div>
            </div>

            <div class="setup-actions">
                <button id="save-api-config" class="upload-btn">å„²å­˜è¨­å®š</button>
                <button id="cancel-api-config" class="upload-btn btn-secondary">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è¦–é »é¸æ“‡å™¨ -->
    <div class="video-selector" id="video-selector">
        <div class="video-options">
            <button class="close-selector" id="close-selector">
                <i class="fas fa-times"></i>
            </button>
            <h3>é¸æ“‡èƒŒæ™¯å½±ç‰‡</h3>
            <div class="video-option" data-video="https://assets.mixkit.co/videos/preview/mixkit-white-clouds-passing-by-1152-large.mp4">
                <div class="video-thumbnail"></div>
                <span>é›²æœµé£„é</span>
            </div>
            <div class="video-option" data-video="https://assets.mixkit.co/videos/preview/mixkit-a-girl-blowing-a-bubble-gum-at-the-beach-12356-large.mp4">
                <div class="video-thumbnail"></div>
                <span>æµ·ç˜æ³¡æ³¡</span>
            </div>
            <div class="video-option" data-video="https://assets.mixkit.co/videos/preview/mixkit-tree-with-yellow-flowers-1173-large.mp4">
                <div class="video-thumbnail"></div>
                <span>é»ƒèŠ±æ¨¹</span>
            </div>
        </div>
    </div>

    <script>
        // ==================== æ™‚é˜åŠŸèƒ½ ====================
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('zh-TW');
            const date = now.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });

            document.getElementById('clock').textContent = time;
            document.getElementById('date').textContent = date;
        }

        updateClock();
        setInterval(updateClock, 1000);

        // ==================== æœç´¢åŠŸèƒ½ ====================
        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    if (query.includes('.') || query.includes('://')) {
                        window.location.href = query.includes('://') ? query : 'https://' + query;
                    } else {
                        window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    }
                }
            }
        });

        // ==================== è®Šæ•¸å®£å‘Š ====================
        const video = document.getElementById('video-background');
        const videoSelector = document.getElementById('video-selector');
        const uploadContainer = document.getElementById('video-upload-container');
        const settingsMenu = document.getElementById('settings-menu');
        const settingsGear = document.getElementById('settings-gear');
        const progressBar = document.getElementById('progress-bar');
        const progress = document.getElementById('progress');
        const uploadStatus = document.getElementById('upload-status');
        const apiSetupContainer = document.getElementById('api-setup-container');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const googleLoginMenu = document.getElementById('google-login-menu');

        let selectedFile = null;
        let selectedVideoUrl = '';
        let cloudVideoUrl = '';
        let googleUser = null;
        let googleConfig = null;

        // ==================== Google æ‡‰ç”¨ç¨‹å¼è³‡æ–™å¤¾åŠŸèƒ½ ====================
        function setupGoogleApps() {
            const appsBtn = document.getElementById('google-apps-btn');
            const appsMenu = document.getElementById('google-apps-menu');
            
            if (!appsBtn || !appsMenu) return;
            
            // é»æ“Šæ‡‰ç”¨ç¨‹å¼æŒ‰éˆ•
            appsBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                appsMenu.style.display = appsMenu.style.display === 'block' ? 'none' : 'block';
            });
            
            // é»æ“Šé é¢å…¶ä»–å€åŸŸé—œé–‰é¸å–®
            document.addEventListener('click', function(e) {
                if (!appsBtn.contains(e.target) && !appsMenu.contains(e.target)) {
                    appsMenu.style.display = 'none';
                }
            });
        }

        // ==================== æ¥µé€Ÿå½±ç‰‡è¼‰å…¥ç³»çµ± ====================
        class UltraFastVideoSystem {
            constructor() {
                this.video = video;
                this.init();
            }

            init() {
                this.optimizeVideoElement();
                this.startUltraFastLoad();
            }

            optimizeVideoElement() {
                if (this.video) {
                    this.video.preload = 'auto';
                    this.video.muted = true;
                    this.video.playsInline = true;
                    this.video.setAttribute('webkit-playsinline', 'true');
                    this.video.setAttribute('playsinline', 'true');
                }
            }

            async startUltraFastLoad() {
                console.log('ğŸš€ å•Ÿå‹•æ¥µé€Ÿå½±ç‰‡è¼‰å…¥...');

                // 1. å…ˆå˜—è©¦ localStorage ç¶²å€ï¼ˆæœ€å¿«ï¼‰
                const videoUrl = localStorage.getItem('videoUrl');
                if (videoUrl) {
                    console.log('âœ… å¾ localStorage è¼‰å…¥ç¶²å€å½±ç‰‡');
                    this.video.src = videoUrl;
                    await this.playVideo();
                    updateCurrentVideoInfo('è‡ªè¨‚ç¶²å€å½±ç‰‡');
                    return;
                }

                // 2. å˜—è©¦æ“´å……åŠŸèƒ½è¼‰å…¥
                if (window.extensionHelper) {
                    try {
                        const result = await window.extensionHelper.loadVideoInstant();
                        if (result.success) {
                            if (result.type === 'url') {
                                this.video.src = result.url;
                            } else if (result.type === 'base64') {
                                this.video.src = result.data;
                            }
                            await this.playVideo();
                            updateCurrentVideoInfo(result.name || 'è‡ªè¨‚å½±ç‰‡');
                            console.log('âœ… æ“´å……åŠŸèƒ½è¼‰å…¥æˆåŠŸ');
                            return;
                        }
                    } catch (error) {
                        console.log('âŒ æ“´å……åŠŸèƒ½è¼‰å…¥å¤±æ•—:', error);
                    }
                }

                // 3. ä½¿ç”¨é è¨­å½±ç‰‡
                console.log('ğŸ“¹ ä½¿ç”¨é è¨­å½±ç‰‡');
                updateCurrentVideoInfo('é è¨­å½±ç‰‡');
                await this.playVideo();
            }

            async playVideo() {
                try {
                    await this.video.play();
                } catch (error) {
                    console.log('â¸ï¸ è‡ªå‹•æ’­æ”¾è¢«é˜»æ­¢ï¼Œä½†å½±ç‰‡å·²è¼‰å…¥');
                }
            }
        }

        // ==================== Google API è¨­å®šç®¡ç† ====================
        class GoogleAPIConfig {
            constructor() {
                this.clientId = localStorage.getItem('google_client_id');
                this.tokenClient = null;
                this.gapiInited = false;
                this.gisInited = false;
                
                const savedAuth = localStorage.getItem('google_auth');
                if (savedAuth) {
                    try {
                        googleUser = JSON.parse(savedAuth);
                        console.log('è¼‰å…¥å·²ä¿å­˜çš„ç™»å…¥ç‹€æ…‹');
                    } catch (e) {
                        console.error('è¼‰å…¥ç™»å…¥ç‹€æ…‹å¤±æ•—:', e);
                        localStorage.removeItem('google_auth');
                    }
                }
                
                if (this.clientId) {
                    this.initGoogleAPI();
                }
            }

            isConfigured() {
                return !!this.clientId;
            }

            saveClientId(clientId) {
                if (clientId && clientId.includes('.apps.googleusercontent.com')) {
                    this.clientId = clientId;
                    localStorage.setItem('google_client_id', clientId);
                    this.initGoogleAPI();
                    return true;
                }
                return false;
            }

            getClientId() {
                return this.clientId;
            }

            async initGoogleAPI() {
                if (!this.clientId) return;

                await new Promise((resolve) => {
                    gapi.load('client:picker', () => {
                        this.gapiInited = true;
                        console.log('GAPI è¼‰å…¥å®Œæˆ');
                        this.initTokenClient();
                        resolve();
                    });
                });
            }

            initTokenClient() {
                if (!this.clientId) return;

                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: this.clientId,
                    scope: 'https://www.googleapis.com/auth/drive.readonly',
                    callback: (response) => {
                        if (response.error !== undefined) {
                            showUploadStatus('Google æˆæ¬Šå¤±æ•—: ' + response.error, 'error');
                            return;
                        }
                        this.handleAuthSuccess(response.access_token);
                    },
                });

                this.gisInited = true;
                this.updateUI();
            }

            handleAuthSuccess(accessToken) {
                const authData = {
                    accessToken: accessToken,
                    timestamp: Date.now()
                };
                googleUser = authData;
                
                localStorage.setItem('google_auth', JSON.stringify(authData));
                
                this.updateUI();
                this.initializePicker();
                showUploadStatus('Google å¸³è™Ÿç™»å…¥æˆåŠŸï¼', 'success');
            }

            isTokenExpired() {
                if (!googleUser || !googleUser.timestamp) return true;
                const oneHour = 60 * 60 * 1000;
                return (Date.now() - googleUser.timestamp) > oneHour;
            }

            updateUI() {
                const isConfigured = this.isConfigured();
                const isAuthenticated = !!googleUser && !this.isTokenExpired();

                if (googleUser && this.isTokenExpired()) {
                    console.log('Token å·²éæœŸï¼Œè‡ªå‹•ç™»å‡º');
                    this.logout();
                    return;
                }

                if (isAuthenticated) {
                    googleLoginBtn.classList.add('authenticated');
                    googleLoginBtn.innerHTML = '<img src="favicon.ico" class="google-icon" alt="Google"><span>å·²é€£ç·š</span>';
                } else {
                    googleLoginBtn.classList.remove('authenticated');
                    googleLoginBtn.innerHTML = '<img src="favicon.ico" class="google-icon" alt="Google"><span>Google</span>';
                }

                document.getElementById('google-drive-picker-btn').style.display = isAuthenticated ? 'flex' : 'none';
                document.getElementById('google-logout-btn').style.display = isAuthenticated ? 'flex' : 'none';

                const driveBtn = document.getElementById('google-drive-btn');
                const statusText = document.getElementById('google-drive-status');
                
                if (isAuthenticated) {
                    driveBtn.disabled = false;
                    statusText.textContent = 'âœ“ Google Drive å·²é€£ç·š';
                    statusText.className = 'google-status connected';
                } else if (isConfigured) {
                    driveBtn.disabled = true;
                    statusText.textContent = 'è«‹é»æ“Šå³ä¸Šè§’ Google æŒ‰éˆ•ç™»å…¥';
                    statusText.className = 'google-status';
                } else {
                    driveBtn.disabled = true;
                    statusText.textContent = 'è«‹å…ˆè¨­å®š Google API';
                    statusText.className = 'google-status';
                }
            }

            async initializePicker() {
                if (!this.gapiInited) return;
                
                try {
                    await gapi.client.init({});
                    console.log('Google Picker åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    console.error('Picker åˆå§‹åŒ–å¤±æ•—:', error);
                }
            }

            async openGoogleDrivePicker() {
                if (!googleUser || !googleUser.accessToken) {
                    throw new Error('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿ');
                }

                if (!this.gapiInited) {
                    throw new Error('Google API å°šæœªåˆå§‹åŒ–å®Œæˆ');
                }

                return new Promise((resolve, reject) => {
                    const view = new google.picker.View(google.picker.ViewId.DOCS);
                    view.setMimeTypes('video/mp4');
                    
                    const picker = new google.picker.PickerBuilder()
                        .setAppId(this.clientId)
                        .setOAuthToken(googleUser.accessToken)
                        .addView(view)
                        .setCallback((data) => {
                            if (data[google.picker.Response.ACTION] === google.picker.Action.PICKED) {
                                const doc = data[google.picker.Response.DOCUMENTS][0];
                                const fileId = doc[google.picker.Document.ID];
                                
                                console.log('é¸æ“‡çš„æª”æ¡ˆ:', doc);
                                
                                const videoUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
                                
                                console.log('ç”Ÿæˆçš„å½±ç‰‡ URL:', videoUrl);
                                
                                resolve({
                                    url: videoUrl,
                                    name: doc.name,
                                    id: fileId,
                                    accessToken: googleUser.accessToken
                                });
                            } else if (data[google.picker.Response.ACTION] === google.picker.Action.CANCEL) {
                                reject(new Error('ç”¨æˆ¶å–æ¶ˆé¸æ“‡'));
                            }
                        })
                        .build();
                    
                    picker.setVisible(true);
                });
            }

            requestAuth() {
                if (this.tokenClient) {
                    this.tokenClient.requestAccessToken();
                } else {
                    showUploadStatus('Google API å°šæœªæº–å‚™å¥½', 'error');
                }
            }

            logout() {
                if (googleUser && googleUser.accessToken) {
                    google.accounts.oauth2.revoke(googleUser.accessToken, () => {
                        console.log('Access token å·²æ’¤éŠ·');
                    });
                }
                
                googleUser = null;
                localStorage.removeItem('google_auth');
                this.updateUI();
                showUploadStatus('å·²ç™»å‡º Google å¸³è™Ÿ', 'info');
            }
        }

        // ==================== å·¥å…·å‡½æ•¸ ====================
        function showUploadStatus(message, type = 'info') {
            uploadStatus.textContent = message;
            uploadStatus.className = 'upload-status';
            uploadStatus.classList.add(type);
            uploadStatus.style.display = 'block';
            
            setTimeout(() => {
                uploadStatus.style.display = 'none';
            }, 3000);
        }

        function updateProgress(percent) {
            progressBar.style.display = 'block';
            progress.style.width = percent + '%';
        }

        function hideProgress() {
            progressBar.style.display = 'none';
            progress.style.width = '0%';
        }

        function updateCurrentVideoInfo(name) {
            const infoElement = document.getElementById('current-video-info');
            const nameElement = document.getElementById('current-video-name');
            if (infoElement && nameElement) {
                infoElement.style.display = 'block';
                nameElement.textContent = name;
            }
        }

        // ==================== Google ç›¸é—œäº‹ä»¶è™•ç† ====================
        googleLoginBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (googleConfig && googleConfig.isConfigured()) {
                if (googleUser && !googleConfig.isTokenExpired()) {
                    googleLoginMenu.style.display = googleLoginMenu.style.display === 'block' ? 'none' : 'block';
                } else {
                    googleConfig.requestAuth();
                }
            } else {
                showAPISetupPrompt();
            }
        });

        // é»æ“Šé é¢å…¶ä»–å€åŸŸé—œé–‰é¸å–®
        document.addEventListener('click', function(e) {
            if (!googleLoginBtn.contains(e.target) && !googleLoginMenu.contains(e.target)) {
                googleLoginMenu.style.display = 'none';
            }
            if (!settingsGear.contains(e.target) && !settingsMenu.contains(e.target)) {
                settingsMenu.style.display = 'none';
            }
        });

        document.getElementById('setup-google-api-btn').addEventListener('click', function() {
            showAPISetupPrompt();
            googleLoginMenu.style.display = 'none';
        });

        document.getElementById('google-drive-picker-btn').addEventListener('click', async function() {
            await openGoogleDrivePicker();
            googleLoginMenu.style.display = 'none';
        });

        document.getElementById('google-logout-btn').addEventListener('click', function() {
            googleConfig.logout();
            googleLoginMenu.style.display = 'none';
        });

        function showAPISetupPrompt() {
            apiSetupContainer.style.display = 'flex';
            if (googleConfig) {
                const savedClientId = googleConfig.getClientId();
                if (savedClientId) {
                    document.getElementById('google-client-id').value = savedClientId;
                }
            }
        }

        document.getElementById('close-api-setup').addEventListener('click', function() {
            apiSetupContainer.style.display = 'none';
        });

        document.getElementById('cancel-api-config').addEventListener('click', function() {
            apiSetupContainer.style.display = 'none';
        });

        document.getElementById('save-api-config').addEventListener('click', function() {
            const clientId = document.getElementById('google-client-id').value.trim();
            if (googleConfig.saveClientId(clientId)) {
                showUploadStatus('Google API è¨­å®šæˆåŠŸï¼', 'success');
                apiSetupContainer.style.display = 'none';
            } else {
                showUploadStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Google OAuth ç”¨æˆ¶ç«¯ ID', 'error');
            }
        });

        async function openGoogleDrivePicker() {
            const btn = document.getElementById('google-drive-btn');
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...';

            try {
                const driveFile = await googleConfig.openGoogleDrivePicker();
                cloudVideoUrl = driveFile.url;
                selectedFile = null;
                selectedVideoUrl = '';
                
                document.getElementById('confirm-upload').disabled = false;
                document.getElementById('file-info').textContent = `å·²é¸æ“‡: ${driveFile.name}`;
                showUploadStatus('Google Drive å½±ç‰‡é¸æ“‡æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('Google Drive é¸æ“‡å¤±æ•—:', error);
                showUploadStatus(`Google Drive é¸æ“‡å¤±æ•—: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fab fa-google-drive"></i> Google Drive';
            }
        }

        // ==================== å½±ç‰‡æ§åˆ¶åŠŸèƒ½ ====================
        settingsGear.addEventListener('click', function(e) {
            e.stopPropagation();
            settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        });

        document.getElementById('play-pause-btn').addEventListener('click', function() {
            if (video.paused) {
                video.play();
                this.innerHTML = '<i class="fas fa-pause"></i><span>æš«åœå½±ç‰‡</span>';
            } else {
                video.pause();
                this.innerHTML = '<i class="fas fa-play"></i><span>æ’­æ”¾å½±ç‰‡</span>';
            }
            settingsMenu.style.display = 'none';
        });

        document.getElementById('mute-btn').addEventListener('click', function() {
            video.muted = !video.muted;
            this.innerHTML = video.muted ? 
                '<i class="fas fa-volume-mute"></i><span>å–æ¶ˆéœéŸ³</span>' : 
                '<i class="fas fa-volume-up"></i><span>éœéŸ³å½±ç‰‡</span>';
            settingsMenu.style.display = 'none';
        });

        document.getElementById('upload-video-btn').addEventListener('click', function() {
            uploadContainer.style.display = 'flex';
            settingsMenu.style.display = 'none';
            resetUploadForm();
        });

        document.getElementById('close-upload').addEventListener('click', function() {
            uploadContainer.style.display = 'none';
            resetUploadForm();
        });

        document.getElementById('google-drive-btn').addEventListener('click', openGoogleDrivePicker);

        document.getElementById('video-file').addEventListener('change', function(e) {
            selectedFile = e.target.files[0];
            cloudVideoUrl = '';
            selectedVideoUrl = '';
            document.getElementById('video-url').value = '';
            
            if (selectedFile) {
                if (selectedFile.type !== 'video/mp4') {
                    showUploadStatus('è«‹é¸æ“‡ MP4 æ ¼å¼çš„å½±ç‰‡æª”æ¡ˆ', 'error');
                    resetUploadForm();
                    return;
                }
                
                if (selectedFile.size > 50 * 1024 * 1024) {
                    showUploadStatus('æª”æ¡ˆå¤ªå¤§ï¼è«‹é¸æ“‡å°æ–¼ 50MB çš„å½±ç‰‡', 'error');
                    resetUploadForm();
                    return;
                }
                
                document.getElementById('confirm-upload').disabled = false;
                document.getElementById('file-info').textContent = 
                    `å·²é¸æ“‡: ${selectedFile.name} (${(selectedFile.size / 1024 / 1024).toFixed(2)} MB)`;
            } else {
                document.getElementById('confirm-upload').disabled = true;
            }
        });

        document.getElementById('load-url-btn').addEventListener('click', function() {
            const url = document.getElementById('video-url').value.trim();
            if (url) {
                selectedVideoUrl = url;
                cloudVideoUrl = '';
                selectedFile = null;
                document.getElementById('video-file').value = '';
                document.getElementById('confirm-upload').disabled = false;
                document.getElementById('file-info').textContent = 'å·²è¼¸å…¥ç¶²å€å½±ç‰‡';
                showUploadStatus('ç¶²å€å½±ç‰‡è¨­å®šæˆåŠŸï¼', 'success');
            } else {
                showUploadStatus('è«‹è¼¸å…¥å½±ç‰‡ç¶²å€', 'error');
            }
        });

        function resetUploadForm() {
            selectedFile = null;
            selectedVideoUrl = '';
            cloudVideoUrl = '';
            document.getElementById('video-file').value = '';
            document.getElementById('video-url').value = '';
            document.getElementById('confirm-upload').disabled = true;
            hideProgress();
            document.getElementById('file-info').textContent = 'æ”¯æ´ MP4 æ ¼å¼ï¼Œæœ€å¤§ 50MB';
            
            const confirmBtn = document.getElementById('confirm-upload');
            confirmBtn.innerHTML = 'ç¢ºèªè¨­å®š';
            confirmBtn.disabled = true;
        }

        // ==================== å½±ç‰‡ä¸Šå‚³ç¢ºèª ====================
        document.getElementById('confirm-upload').addEventListener('click', async function() {
            const confirmBtn = this;
            confirmBtn.disabled = true;
            const originalText = confirmBtn.innerHTML;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è¨­å®šä¸­...';

            try {
                let videoUrl;
                let videoName;

                if (selectedVideoUrl) {
                    videoUrl = selectedVideoUrl;
                    videoName = 'è‡ªè¨‚ç¶²å€å½±ç‰‡';
                    localStorage.setItem('videoUrl', selectedVideoUrl);
                    console.log('âœ… ç¶²å€å½±ç‰‡è¨­å®šå®Œæˆ');
                    
                } else if (selectedFile) {
                    videoName = selectedFile.name;
                    
                    if (window.extensionHelper) {
                        try {
                            const result = await window.extensionHelper.saveVideoUltraFast(selectedFile);
                            videoUrl = result.blobUrl;
                            console.log('âœ… æ¥µé€Ÿå„²å­˜å®Œæˆ');
                        } catch (error) {
                            console.log('âŒ æ¥µé€Ÿå„²å­˜å¤±æ•—ï¼Œé™ç´šåˆ° Blob URL:', error);
                            videoUrl = URL.createObjectURL(selectedFile);
                        }
                    } else {
                        videoUrl = URL.createObjectURL(selectedFile);
                    }
                    
                } else if (cloudVideoUrl) {
                    console.log('é–‹å§‹è¼‰å…¥ Google Drive å½±ç‰‡...');
                    
                    const response = await fetch(cloudVideoUrl, {
                        headers: {
                            'Authorization': `Bearer ${googleUser.accessToken}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const blob = await response.blob();
                    videoUrl = URL.createObjectURL(blob);
                    videoName = 'Google Drive å½±ç‰‡';
                    
                    console.log('âœ… é›²ç«¯å½±ç‰‡è¼‰å…¥æˆåŠŸ');
                    
                    if (window.extensionHelper) {
                        try {
                            await window.extensionHelper.saveCloudVideo(cloudVideoUrl, 'Google Drive å½±ç‰‡');
                        } catch (error) {
                            console.log('æ“´å……åŠŸèƒ½ä¿å­˜å¤±æ•—:', error);
                        }
                    }
                }

                if (videoUrl) {
                    video.src = videoUrl;
                    video.play();
                    updateCurrentVideoInfo(videoName);
                    
                    showUploadStatus('å½±ç‰‡è¨­å®šæˆåŠŸï¼', 'success');
                    
                    setTimeout(() => {
                        uploadContainer.style.display = 'none';
                        resetUploadForm();
                    }, 1500);
                } else {
                    throw new Error('æ²’æœ‰é¸æ“‡æœ‰æ•ˆçš„å½±ç‰‡ä¾†æº');
                }
                
            } catch (error) {
                console.error('è¨­å®šå¤±æ•—:', error);
                showUploadStatus(`è¨­å®šå¤±æ•—: ${error.message}`, 'error');
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
            }
        });

        // ==================== å½±ç‰‡éŒ¯èª¤è™•ç† ====================
        video.addEventListener('error', function() {
            console.error('âŒ å½±ç‰‡è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­å½±ç‰‡');
            video.src = 'https://assets.mixkit.co/videos/preview/mixkit-white-clouds-passing-by-1152-large.mp4';
            video.play();
            updateCurrentVideoInfo('é è¨­å½±ç‰‡');
        });

        // ==================== è¦–é »é¸æ“‡å™¨åŠŸèƒ½ ====================
        document.getElementById('video-select-btn').addEventListener('click', function () {
            videoSelector.style.display = 'flex';
        });

        document.getElementById('close-selector').addEventListener('click', function () {
            videoSelector.style.display = 'none';
        });

        document.querySelectorAll('.video-option').forEach(option => {
            option.addEventListener('click', function () {
                const videoUrl = this.getAttribute('data-video');
                video.src = videoUrl;
                video.play();
                videoSelector.style.display = 'none';

                localStorage.setItem('selectedVideo', videoUrl);
            });
        });

        // ==================== é é¢åˆå§‹åŒ– ====================
        window.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é é¢é–‹å§‹è¼‰å…¥...');
            
            // åˆå§‹åŒ– Google API è¨­å®šç®¡ç†å™¨
            googleConfig = new GoogleAPIConfig();

            // å•Ÿå‹•æ¥µé€Ÿå½±ç‰‡ç³»çµ±
            new UltraFastVideoSystem();
            
            // è¨­ç½® Google æ‡‰ç”¨ç¨‹å¼è³‡æ–™å¤¾
            setupGoogleApps();
            
            // èšç„¦æœç´¢æ¡†
            setTimeout(() => {
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.focus();
            }, 500);
        });

        // æ¸…ç† blob URL
        window.addEventListener('beforeunload', function() {
            if (video.src && video.src.startsWith('blob:')) {
                URL.revokeObjectURL(video.src);
            }
        });
    </script>
</body>
</html>
